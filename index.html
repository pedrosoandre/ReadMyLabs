<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ReadMyLabs</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1048790347778574" crossorigin="anonymous"></script>
  <script async custom-element="amp-auto-ads"
          src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script>
  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Adiciona Tesseract.js e PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configurar PDF.js
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body style="font-family: 'Inter', sans-serif;">
  <div id="google_translate_element" style="display:none"></div>
  <amp-auto-ads type="adsense"
        data-ad-client="ca-pub-1048790347778574">
  </amp-auto-ads>
  <header class="toolbar" style="display:flex;align-items:center;justify-content:center;gap:32px;min-height:72px;width:100vw;">
          <ul class="menu" style="justify-content:center;width:auto;">
        <li><a href="paginas/labs.html">Labs</a></li>
        <li><a href="paginas/exames.html">Exames</a></li>
        <li><a href="paginas/parcerias.html">Parcerias</a></li>
        <li><a href="paginas/laboratorios_hospitais.html">Laborat√≥rios e Hospitais</a></li>
      </ul>
  </header>
  
  <header style="width:100%;background:#007BFF;padding:22px 0 18px 0;box-shadow:0 2px 8px rgba(0,0,0,0.07);margin-bottom:32px;">
    <h1 style="color:#fff;font-family:'Segoe UI',Arial,sans-serif;font-size:2.1em;font-weight:700;text-align:center;letter-spacing:0.04em;margin:0;">Read My Labs</h1>
  </header>

  <h2 style="color:#007BFF;"> An√°lise de Documentos e Sintomas</h2>
  <label for="arquivo"><strong>Envie um documento (PDF ou imagem):</strong></label>
  <input type="file" id="arquivo" accept=".pdf,image/*" />
  <div id="recaptcha-exames" style="margin: 16px 0;"></div>
  <button id="btnUpload" style="margin-top:10px;">Analisar Exame</button>

  <!-- Modal para exibir resultado da an√°lise do documento -->
  <div id="modalResultado" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:40px;border-radius:15px;width:95vw;height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative;border:3px solid transparent;background-clip:padding-box;background-image:linear-gradient(white, white), linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);background-origin:border-box;background-clip:padding-box, border-box;">
      <span id="fecharModal" style="position:absolute;top:15px;right:25px;font-size:28px;cursor:pointer;color:#666;font-weight:bold;z-index:10;">&times;</span>
      <div id="conteudoModal"></div>
      <div id="botoesModal" style="margin-top:30px;text-align:center;"></div>
    </div>
  </div>

  <hr style="margin:40px 0 30px 0; border:0; border-top:2px solid #007BFF;">

  <h2 style="color:#007BFF;">An√°lise de Sintomas:</h2>
  <label for="sintomas">Descreva seus sintomas:</label>
  <textarea id="sintomas" rows="7" placeholder="Exemplo: estou com dor no peito, febre e calafrios..."></textarea>

  <label for="duracao">Dura√ß√£o dos sintomas:</label>
  <select id="duracao" class="select-menor">
    <option value="">Selecione</option>
    <option value="Menos de 1 dia">Menos de 1 dia</option>
    <option value="1 a 3 dias">1 a 3 dias</option>
    <option value="4 a 7 dias">4 a 7 dias</option>
    <option value="Mais de 1 semana">Mais de 1 semana</option>
  </select>

  <label for="intensidade">Intensidade da dor:</label>
  <select id="intensidade" class="select-menor">
    <option value="">Selecione</option>
    <option value="Leve">Leve</option>
    <option value="Moderada">Moderada</option>
    <option value="Forte">Forte</option>
    <option value="Insuport√°vel">Insuport√°vel</option>
  </select>

  <div class="g-recaptcha" data-sitekey="6Lfj2IcrAAAAABVLFqE3bNN9zBb-RqB_9jvPsEf-" style="margin: 20px auto; display: inline-block;"></div>
  <button onclick="analisarSintomas()" style="margin-top:18px;">Analisar Sintomas</button>

  <div id="resposta"></div>

  <section style="max-width: 900px; margin: 40px auto 0 auto; text-align: left;">
    <h3 style="margin-bottom: 18px; color: #007bff;">Sa√∫de e Bem-Estar: A Jornada da Medicina e o Papel Fundamental dos Exames</h3>
    <p style="text-align: justify; margin-bottom: 18px;">A sa√∫de √© um dos pilares fundamentais da vida humana. Ao longo dos s√©culos, a medicina evoluiu de pr√°ticas rudimentares para uma ci√™ncia altamente especializada e baseada em evid√™ncias. Desde os tempos antigos, quando os curandeiros utilizavam ervas e rituais, at√© os dias atuais, com tecnologias de ponta como a intelig√™ncia artificial e a gen√©tica personalizada, a busca pelo bem-estar f√≠sico, mental e emocional tem sido constante.</p>
    <p style="text-align: justify; margin-bottom: 18px;">A Organiza√ß√£o Mundial da Sa√∫de (OMS) desempenha um papel central nesse processo, promovendo pol√≠ticas globais de sa√∫de, prevenindo doen√ßas e fomentando o acesso universal √† sa√∫de de qualidade. A OMS define sa√∫de n√£o apenas como a aus√™ncia de doen√ßa, mas como um estado completo de bem-estar f√≠sico, mental e social. Essa vis√£o hol√≠stica refor√ßa a import√¢ncia de medidas preventivas, como a realiza√ß√£o peri√≥dica de exames laboratoriais.</p>
    <p style="text-align: justify; margin-bottom: 18px;">J√° o PubMed, uma das maiores bibliotecas cient√≠ficas do mundo, mantida pelo National Institutes of Health (NIH), re√∫ne milh√µes de artigos cient√≠ficos que orientam decis√µes cl√≠nicas e pol√≠ticas de sa√∫de em todos os pa√≠ses. √â l√° que m√©dicos, pesquisadores e profissionais de sa√∫de encontram as mais recentes descobertas sobre doen√ßas, tratamentos e diagn√≥sticos. O acesso ao conhecimento cient√≠fico de qualidade √© o que mant√©m a medicina em constante evolu√ß√£o e permite salvar vidas diariamente.</p>
    <p style="text-align: justify; margin-bottom: 18px;">Mas nada disso seria poss√≠vel sem os m√©dicos, profissionais dedicados √† arte de cuidar. Eles s√£o os guardi√µes da sa√∫de p√∫blica e individual, e sua forma√ß√£o constante os permite interpretar sintomas, exames e comportamentos com um olhar cl√≠nico preciso. Mais do que prescritores de medicamentos, os m√©dicos s√£o orientadores da vida, companheiros na preven√ß√£o e no tratamento das doen√ßas.</p>
    <p style="text-align: justify; margin-bottom: 18px;">Os laborat√≥rios de an√°lises cl√≠nicas, por sua vez, s√£o os grandes aliados desses profissionais. A coleta e interpreta√ß√£o correta de exames laboratoriais ‚Äî como hemogramas, an√°lises hormonais, testes de fun√ß√£o renal, exames de imagem, entre outros ‚Äî s√£o pe√ßas-chave no diagn√≥stico precoce e no monitoramento de condi√ß√µes cr√¥nicas, como diabetes, hipertens√£o, colesterol alto, doen√ßas card√≠acas, c√¢ncer e infec√ß√µes.</p>
    <p style="text-align: justify; margin-bottom: 18px;">√â por isso que fazer exames peri√≥dicos √© mais do que um cuidado: √© uma atitude de amor pr√≥prio. Muitas doen√ßas s√£o silenciosas no in√≠cio e s√≥ se manifestam quando j√° est√£o em est√°gio avan√ßado. A preven√ß√£o, nesse contexto, √© a melhor arma. E a rotina de exames deve ser parte do autocuidado, assim como se alimenta bem ou pratica exerc√≠cios f√≠sicos.</p>
    <p style="text-align: justify; margin-bottom: 18px;">Nos √∫ltimos anos, o avan√ßo tecnol√≥gico permitiu que a medicina se tornasse mais acess√≠vel, precisa e integrada. Hoje, plataformas como a ReadMyLabs tornam poss√≠vel analisar exames com o aux√≠lio da intelig√™ncia artificial, interpretando sintomas e auxiliando tanto pacientes quanto profissionais de sa√∫de a tomarem decis√µes informadas.</p>
    <p style="text-align: justify; margin-bottom: 18px;">A hist√≥ria da medicina est√° em constante constru√ß√£o. E cada pessoa que se cuida, que realiza exames, que procura um m√©dico ao menor sinal de alerta, contribui para um mundo mais saud√°vel e consciente.</p>
    <p style="text-align: justify; margin-bottom: 18px;">Lembre-se: cuidar da sa√∫de √© um investimento que vale mais do que ouro. Consulte regularmente um m√©dico, confie em laborat√≥rios de confian√ßa e use a tecnologia a seu favor. Sua sa√∫de agradece.</p>
  </section>

  <script>
    // Tradu√ß√£o autom√°tica para ingl√™s se o navegador estiver em ingl√™s
    (function() {
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang && userLang.startsWith('en')) {
        var gt = document.createElement('script');
        gt.type = 'text/javascript';
        gt.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(gt);
        document.getElementById('google_translate_element').style.display = 'block';
      }
    })();
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'pt',
        includedLanguages: 'en,pt',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
    let widgetIdExames;
    window.onload = function() {
      // Verificar se o reCAPTCHA est√° dispon√≠vel
      if (typeof grecaptcha !== 'undefined') {
        // Renderizar o reCAPTCHA de exames de forma expl√≠cita
        widgetIdExames = grecaptcha.render('recaptcha-exames', {
          'sitekey': '6Lfj2IcrAAAAABVLFqE3bNN9zBb-RqB_9jvPsEf-'
        });
      } else {
        console.error('reCAPTCHA n√£o est√° carregado');
        // Criar um fallback se o reCAPTCHA n√£o carregar
        document.getElementById('recaptcha-exames').innerHTML = '<p style="color: red;">Erro ao carregar reCAPTCHA. Recarregue a p√°gina.</p>';
      }
    };

    // Fun√ß√£o para gerar template HTML profissional
    function gerarTemplateHTML(tipo, dados, analise) {
      const dataAtual = new Date().toLocaleDateString('pt-BR');
      let infoPaciente = '';
      let infoExtra = '';
      let tituloSecao = '';
      let metodo = '';
      let especialidade = '';
      if (tipo === 'exame') {
        infoPaciente = `<strong>Arquivo:</strong> ${dados.nomeArquivo}<br>`;
        infoPaciente += `<strong>Data da An√°lise:</strong> ${dataAtual}<br>`;
        infoPaciente += `<strong>Tipo de Exame:</strong> An√°lise de documento PDF`;
        tituloSecao = 'Resultado da An√°lise';
        metodo = dados.metodo || '';
      } else {
        infoPaciente = `<strong>Sintomas:</strong> ${dados.sintomas}<br>`;
        infoPaciente += `<strong>Dura√ß√£o:</strong> ${dados.duracao}<br>`;
        infoPaciente += `<strong>Intensidade:</strong> ${dados.intensidade}<br>`;
        infoPaciente += `<strong>Data da An√°lise:</strong> ${dataAtual}`;
        tituloSecao = 'Resultado da An√°lise de Sintomas';
        metodo = '';
      }

      // Separar an√°lise em se√ß√µes se poss√≠vel
      let secaoInter = '', secaoDiag = '', secaoFatores = '', secaoAcao = '', secaoEsp = '', secaoObs = '';
      // Tenta separar por marcadores, se existirem
      if (analise.includes('**Interpreta√ß√£o Geral**')) {
        const regex = /\*\*Interpreta√ß√£o Geral\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoInter = match ? match[1].trim() : '';
      }
      if (analise.includes('**Poss√≠veis Causas**') || analise.includes('**Poss√≠veis Diagn√≥sticos**')) {
        const regex = /\*\*(Poss√≠veis Causas|Poss√≠veis Diagn√≥sticos)\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoDiag = match ? match[2].trim() : '';
      }
      if (analise.includes('**Fatores de Aten√ß√£o**')) {
        const regex = /\*\*Fatores de Aten√ß√£o\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoFatores = match ? match[1].trim() : '';
      }
      if (analise.includes('**Recomenda√ß√£o de A√ß√£o**')) {
        const regex = /\*\*Recomenda√ß√£o de A√ß√£o\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoAcao = match ? match[1].trim() : '';
      }
      if (analise.includes('**Especialidades Sugeridas**')) {
        const regex = /\*\*Especialidades Sugeridas\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoEsp = match ? match[1].trim() : '';
      }
      if (analise.includes('**Observa√ß√µes**')) {
        const regex = /\*\*Observa√ß√µes\*\*:(.*?)(?=\*\*|$)/s;
        const match = analise.match(regex);
        secaoObs = match ? match[1].trim() : '';
      }

      // Fallback: se n√£o conseguir separar, coloca tudo em Interpreta√ß√£o Geral
      if (!secaoInter && !secaoDiag && !secaoFatores && !secaoAcao && !secaoEsp) {
        secaoInter = analise;
      }

      return `
      <!DOCTYPE html>
      <html lang="pt-BR">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Resultado da An√°lise - Read My Labs</title>
        <style>
          body { font-family: 'Inter', 'Helvetica Neue', sans-serif; background-color: #f7f7f7; margin: 0; padding: 40px; color: #333; }
          .container { background-color: #fff; max-width: 800px; margin: auto; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #ddd; }
          .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
          .header h1 { font-size: 24px; color: #0d2f66; margin: 0; }
          .header img { height: 50px; }
          .section { margin-bottom: 30px; }
          .section h2 { font-size: 18px; color: #0d2f66; margin-bottom: 10px; border-left: 4px solid #0d2f66; padding-left: 10px; }
          .section p { font-size: 15px; line-height: 1.6; margin: 0; }
          .footer { font-size: 13px; color: #777; border-top: 1px solid #ccc; padding-top: 20px; text-align: center; }
          .highlight { color: #b30000; font-weight: bold; }
          .button { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #0d2f66; color: white; text-decoration: none; border-radius: 5px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>Read My Labs</h1>
            <img src="https://www.weinmann.com.br/imagens/logo.png" alt="Logo Weinmann">
          </div>

          <div class="section">
            <h2>${tituloSecao}</h2>
            <p>${infoPaciente}</p>
          </div>

          <div class="section">
            <h2>Interpreta√ß√£o Geral</h2>
            <p>${secaoInter}</p>
          </div>

          <div class="section">
            <h2>Poss√≠veis Diagn√≥sticos</h2>
            <p>${secaoDiag}</p>
          </div>

          <div class="section">
            <h2>Fatores de Aten√ß√£o</h2>
            <p>${secaoFatores}</p>
          </div>

          <div class="section">
            <h2>Recomenda√ß√£o de A√ß√£o</h2>
            <p>${secaoAcao}</p>
          </div>

          <div class="section">
            <h2>Especialidades Sugeridas</h2>
            <p>${secaoEsp}</p>
          </div>

          <div class="section">
            <h2>Observa√ß√µes</h2>
            <p>Lembre-se, esta √© apenas uma orienta√ß√£o educativa baseada nos dados fornecidos. A consulta com um profissional de sa√∫de √© essencial para uma avalia√ß√£o adequada e personalizada.</p>
          </div>

          <div class="footer">
            Baseado nas diretrizes m√©dicas internacionais e evid√™ncias cient√≠ficas. <br>
            ¬© 2025 Read My Labs. Todos os direitos reservados.
          </div>
        </div>
      </body>
      </html>
      `;
    }

    // Fun√ß√£o para gerar PDF do template HTML
    function gerarPDF(tipo, dados, analise) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configura√ß√µes de fonte
      doc.setFont("helvetica");
      doc.setFontSize(20);
      
      // T√≠tulo principal
      doc.setTextColor(13, 47, 102); // Azul escuro
      doc.text("Read My Labs", 105, 20, { align: "center" });
      
      // Subt√≠tulo
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      const titulo = tipo === 'exame' ? 'An√°lise de Exame Laboratorial' : 'An√°lise de Sintomas';
      doc.text(titulo, 105, 35, { align: "center" });
      
      // Data
      doc.setFontSize(12);
      const dataAtual = new Date().toLocaleDateString('pt-BR');
      doc.text(`Data da an√°lise: ${dataAtual}`, 105, 45, { align: "center" });
      
      // Linha separadora
      doc.setDrawColor(13, 47, 102);
      doc.line(20, 50, 190, 50);
      
      // Dados do paciente
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      let y = 65;
      
      if (tipo === 'exame') {
        doc.text(`Arquivo: ${dados.nomeArquivo}`, 20, y);
        y += 10;
      } else {
        doc.text(`Sintomas: ${dados.sintomas}`, 20, y);
        y += 10;
        doc.text(`Dura√ß√£o: ${dados.duracao}`, 20, y);
        y += 10;
        doc.text(`Intensidade: ${dados.intensidade}`, 20, y);
        y += 15;
      }
      
      // An√°lise
      doc.setFontSize(12);
      const maxWidth = 170;
      const lineHeight = 7;
      
      const linhas = doc.splitTextToSize(analise, maxWidth);
      
      for (let i = 0; i < linhas.length; i++) {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(linhas[i], 20, y);
        y += lineHeight;
      }
      
      // Rodap√©
      doc.setFontSize(10);
      doc.setTextColor(128, 128, 128);
      doc.text("Este documento foi gerado automaticamente pelo Read My Labs.", 105, 280, { align: "center" });
      doc.text("Para diagn√≥stico definitivo, consulte sempre um profissional de sa√∫de.", 105, 285, { align: "center" });
      
      // Nome do arquivo
      const nomeArquivo = `readmylabs_${tipo}_${dataAtual.replace(/\//g, '-')}.pdf`;
      
      // Download do PDF
      doc.save(nomeArquivo);
    }

    async function analisarSintomas() {
      const sintomas = document.getElementById('sintomas').value.trim();
      const duracao = document.getElementById('duracao').value.trim();
      const intensidade = document.getElementById('intensidade').value.trim();

      if (!sintomas) {
        alert("Descreva os sintomas antes de enviar.");
        return;
      }

      // Capturar token do reCAPTCHA
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        alert("Por favor, marque o reCAPTCHA antes de continuar.");
        return;
      }

      const respostaDiv = document.getElementById('resposta');
      respostaDiv.innerHTML = "‚è≥ Analisando sintomas...";

      try {
        const formData = new FormData();
        formData.append('tipo', 'sintomas');
        formData.append('sintomas', sintomas);
        formData.append('duracao', duracao);
        formData.append('intensidade', intensidade);
        formData.append('g-recaptcha-response', recaptchaResponse);

        const resposta = await fetch('analisar.php', {
          method: 'POST',
          body: formData
        });

        const textoBruto = await resposta.text();
        console.log("üîç Resposta bruta do PHP:", textoBruto);

        let dados;
        try {
          dados = JSON.parse(textoBruto);
        } catch (e) {
          respostaDiv.innerHTML = "‚ùå Erro no retorno do servidor: resposta inv√°lida.";
          return;
        }

        // Verificar se o limite foi atingido
        if (dados.limite_atingido) {
          mostrarPopupLimite(dados.resposta);
          return;
        }

        // Gerar template HTML
        const dadosSintomas = {
          sintomas: sintomas,
          duracao: duracao,
          intensidade: intensidade
        };
        
        const templateHTML = gerarTemplateHTML('sintomas', dadosSintomas, dados.resposta);
        
                 // Criar iframe para exibir o template
         const iframe = document.createElement('iframe');
         iframe.style.width = '100%';
         iframe.style.height = '70vh';
         iframe.style.border = 'none';
         iframe.style.borderRadius = '12px';
         iframe.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        
        const resultadoHTML = `
          <div style="margin-top: 20px;">
            <button onclick="gerarPDF('sintomas', ${JSON.stringify(dadosSintomas)}, \`${dados.resposta.replace(/`/g, '\\`')}\`)" 
                    style="background-color:#0d2f66; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-bottom:15px;">
              üìÑ Baixar PDF
            </button>
          </div>
        `;
        
        respostaDiv.innerHTML = resultadoHTML;
        respostaDiv.appendChild(iframe);
        
        // Escrever o HTML no iframe
        iframe.contentDocument.open();
        iframe.contentDocument.write(templateHTML);
        iframe.contentDocument.close();
        
        // Processar medicamentos se existirem na resposta
        if (dados.resposta.includes('MEDICAMENTOS SUGERIDOS:')) {
            const medicamentosMatch = dados.resposta.match(/MEDICAMENTOS SUGERIDOS:(.*?)(?=\n\n|\Z)/s);
            if (medicamentosMatch) {
                const medicamentosTexto = medicamentosMatch[1].trim();
                localStorage.setItem('medicamentos', medicamentosTexto);
                
                // Extrair medicamentos para atualiza√ß√£o de pre√ßos
                const medicamentosArray = extrairMedicamentosParaAPI(medicamentosTexto);
                localStorage.setItem('medicamentosArray', JSON.stringify(medicamentosArray));
            }
        }
        
        // Salvar dados no localStorage e redirecionar para resultado.html
        localStorage.setItem('resultado', dados.resposta);
        localStorage.setItem('tipo', 'sintomas');
        localStorage.setItem('info', `Sintomas: ${sintomas}\nDura√ß√£o: ${duracao}\nIntensidade: ${intensidade}`);
        localStorage.removeItem('pdf'); // PDF ser√° gerado na p√°gina de resultado
        window.location.href = 'paginas/resultado.html';
        grecaptcha.reset();
      } catch (erro) {
        console.error("üî• Erro na requisi√ß√£o:", erro);
        respostaDiv.innerHTML = "‚ùå Erro ao analisar. Tente novamente.";
      }
    }

    // Fun√ß√£o para mostrar o modal
    function mostrarModal(conteudo, dadosExame = null, analise = null) {
      if (dadosExame && analise) {
        // Gerar template HTML para exame
        const templateHTML = gerarTemplateHTML('exame', dadosExame, analise);
        
                 // Criar iframe para exibir o template
         const iframe = document.createElement('iframe');
         iframe.style.width = '100%';
         iframe.style.height = '85vh';
         iframe.style.border = 'none';
         iframe.style.borderRadius = '12px';
         iframe.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        
        const botoesDiv = document.getElementById('botoesModal');
        botoesDiv.innerHTML = `
          <button onclick="gerarPDF('exame', ${JSON.stringify(dadosExame)}, \`${analise.replace(/`/g, '\\`')}\`)" 
                  style="background-color:#0d2f66; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
            üìÑ Baixar PDF
          </button>
        `;
        
        document.getElementById('conteudoModal').innerHTML = '';
        document.getElementById('conteudoModal').appendChild(iframe);
        
        // Escrever o HTML no iframe
        iframe.contentDocument.open();
        iframe.contentDocument.write(templateHTML);
        iframe.contentDocument.close();
      } else {
        document.getElementById('conteudoModal').innerHTML = conteudo;
        document.getElementById('botoesModal').innerHTML = '';
      }
      
      document.getElementById('modalResultado').style.display = 'flex';
    }
    
    // Fechar modal ao clicar no X
    document.getElementById('fecharModal').onclick = function() {
      document.getElementById('modalResultado').style.display = 'none';
    };
    // Fechar modal ao clicar fora do conte√∫do
    document.getElementById('modalResultado').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };

    // Fun√ß√£o para extrair medicamentos para API
    function extrairMedicamentosParaAPI(texto) {
        const medicamentos = [];
        const linhas = texto.split('\n');
        let categoriaAtual = '';
        
        linhas.forEach(linha => {
            linha = linha.trim();
            if (linha && !linha.match(/^\d+\./)) {
                // √â uma categoria
                categoriaAtual = linha.replace(':', '');
            } else if (linha.match(/^\d+\.\s*(.*?)\s*-\s*R\$\s*([\d,]+)/)) {
                // √â um medicamento
                const match = linha.match(/^\d+\.\s*(.*?)\s*-\s*R\$\s*([\d,]+)/);
                const nome = match[1].replace(/\(.*?\)/g, '').trim();
                const preco = match[2];
                const tipo = determinarTipoMedicamento(nome);
                
                medicamentos.push({
                    nome: nome,
                    tipo: tipo,
                    categoria: categoriaAtual,
                    preco: preco
                });
            }
        });
        
        return medicamentos;
    }

    // Fun√ß√£o para determinar tipo de medicamento
    function determinarTipoMedicamento(nome) {
        const nomeLower = nome.toLowerCase();
        if (nomeLower.includes('refer√™ncia') || nomeLower.includes('original')) return 'referencia';
        if (nomeLower.includes('similar')) return 'similar';
        if (nomeLower.includes('gen√©rico') || nomeLower.includes('generico')) return 'generico';
        return 'generico';
    }

    // Substituir analisarDocumento para usar OCR no navegador
    async function analisarDocumento() {
      const input = document.getElementById('arquivo');
      if (!input.files || input.files.length === 0) {
        alert('Selecione um exame (PDF ou imagem) para an√°lise.');
        return;
      }
      
      // Verificar se o reCAPTCHA foi preenchido
      const recaptchaResponse = grecaptcha.getResponse(widgetIdExames);
      if (!recaptchaResponse) {
        alert('Por favor, marque o reCAPTCHA antes de continuar.');
        return;
      }
      const file = input.files[0];
      let textoExtraido = '';
      
      if (file.type.startsWith('image/')) {
        // OCR direto em imagem
        const reader = new FileReader();
        reader.onload = async function(e) {
          mostrarModal('‚è≥ Realizando OCR na imagem...');
          const { data: { text } } = await Tesseract.recognize(
            e.target.result,
            'por',
            { logger: m => console.log(m) }
          );
          textoExtraido = text;
          enviarTextoParaBackend(textoExtraido, file.name);
        };
        reader.readAsDataURL(file);
        return;
      } else if (file.type === 'application/pdf') {
        // M√©todo 1: Tentar extrair texto pesquis√°vel do PDF primeiro
        if (window.pdfjsLib) {
          try {
            mostrarModal('‚è≥ Extraindo texto pesquis√°vel do PDF...');
            const pdfData = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: pdfData }).promise;
            let textoTotal = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              const pageText = content.items.map(item => item.str).join(' ');
              textoTotal += pageText + '\n';
            }
            if (textoTotal.replace(/\s/g, '').length > 0) {
              // Se encontrou texto, envia para o backend
              enviarTextoParaBackend(textoTotal, file.name);
              return;
            }
            // Se n√£o encontrou texto, faz OCR
            mostrarModal('‚è≥ N√£o foi encontrado texto pesquis√°vel. Realizando OCR...');
          } catch (e) {
            console.log('PDF.js falhou, tentando OCR direto:', e);
            mostrarModal('‚è≥ PDF.js n√£o dispon√≠vel. Realizando OCR...');
          }
        }
        
        // M√©todo 2: OCR em PDF usando PDF.js + Tesseract.js
        if (window.pdfjsLib) {
          try {
            const pdfData = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: pdfData }).promise;
            let textoTotal = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const viewport = page.getViewport({ scale: 2 });
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              await page.render({ canvasContext: context, viewport: viewport }).promise;
              const dataUrl = canvas.toDataURL('image/png');
              const { data: { text } } = await Tesseract.recognize(
                dataUrl,
                'por',
                { logger: m => console.log(m) }
              );
              textoTotal += text + '\n';
            }
            enviarTextoParaBackend(textoTotal, file.name);
            return;
          } catch (erro) {
            console.log('OCR com PDF.js falhou:', erro);
          }
        }
        
        // M√©todo 3: Fallback - enviar arquivo para o backend tentar extrair
        mostrarModal('‚è≥ Enviando arquivo para processamento no servidor...');
        const formData = new FormData();
        formData.append('tipo', 'exame');
        formData.append('arquivo', file);
        const recaptchaResponse = grecaptcha.getResponse(widgetIdExames);
        formData.append('g-recaptcha-response', recaptchaResponse);
        
        fetch('analisar.php', {
          method: 'POST',
          body: formData
        })
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(dados => {
            if (!dados || !dados.resposta) {
              throw new Error('Resposta inv√°lida do servidor');
            }
            
            // Verificar se o limite foi atingido
            if (dados.limite_atingido) {
              mostrarPopupLimite(dados.resposta);
              return;
            }
            
                      // Processar medicamentos se existirem na resposta
          if (dados.resposta.includes('MEDICAMENTOS SUGERIDOS:')) {
            const medicamentosMatch = dados.resposta.match(/MEDICAMENTOS SUGERIDOS:(.*?)(?=\n\n|\Z)/s);
            if (medicamentosMatch) {
              localStorage.setItem('medicamentos', medicamentosMatch[1]);
            }
          }
          
          // Extrair informa√ß√µes do laborat√≥rio da resposta
          let infoLab = `Arquivo: ${file.name}`;
          if (dados.resposta.includes('üè• Laborat√≥rio:')) {
            const labMatch = dados.resposta.match(/üè• Laborat√≥rio:\s*([^\n]+)/);
            if (labMatch) {
              infoLab += `\nLaborat√≥rio: ${labMatch[1].trim()}`;
            }
          }
          
          localStorage.setItem('resultado', dados.resposta);
          localStorage.setItem('tipo', 'exame');
          localStorage.setItem('info', infoLab);
          localStorage.removeItem('pdf');
          window.location.href = 'paginas/resultado.html';
          grecaptcha.reset(widgetIdExames);
          })
          .catch((error) => {
            console.error('Erro na requisi√ß√£o:', error);
            mostrarModal(`‚ùå Erro ao processar arquivo: ${error.message}. Tente novamente.`);
            grecaptcha.reset(widgetIdExames);
          });
        return;
      } else {
        alert('Formato de arquivo n√£o suportado para OCR. Envie uma imagem ou PDF.');
        return;
      }
    }

    function enviarTextoParaBackend(textoExtraido, nomeArquivo) {
      const formData = new FormData();
      formData.append('tipo', 'exame');
      formData.append('conteudo_ocr', textoExtraido);
      formData.append('nome_arquivo', nomeArquivo);
      // Adicione o token do reCAPTCHA se necess√°rio
      const recaptchaResponse = grecaptcha.getResponse(widgetIdExames);
      formData.append('g-recaptcha-response', recaptchaResponse);
      
      fetch('analisar.php', {
        method: 'POST',
        body: formData
      })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(dados => {
          if (!dados || !dados.resposta) {
            throw new Error('Resposta inv√°lida do servidor');
          }
          
          // Verificar se o limite foi atingido
          if (dados.limite_atingido) {
            mostrarPopupLimite(dados.resposta);
            return;
          }
          
          // Processar medicamentos se existirem na resposta
          if (dados.resposta.includes('MEDICAMENTOS SUGERIDOS:')) {
            const medicamentosMatch = dados.resposta.match(/MEDICAMENTOS SUGERIDOS:(.*?)(?=\n\n|\Z)/s);
            if (medicamentosMatch) {
              localStorage.setItem('medicamentos', medicamentosMatch[1]);
            }
          }
          
          // Extrair informa√ß√µes do laborat√≥rio da resposta
          let infoLab = `Arquivo: ${nomeArquivo}`;
          if (dados.resposta.includes('üè• Laborat√≥rio:')) {
            const labMatch = dados.resposta.match(/üè• Laborat√≥rio:\s*([^\n]+)/);
            if (labMatch) {
              infoLab += `\nLaborat√≥rio: ${labMatch[1].trim()}`;
            }
          }
          
          // Salvar dados no localStorage e redirecionar para resultado.html
          localStorage.setItem('resultado', dados.resposta);
          localStorage.setItem('tipo', 'exame');
          localStorage.setItem('info', infoLab);
          localStorage.removeItem('pdf');
          window.location.href = 'paginas/resultado.html';
          grecaptcha.reset(widgetIdExames);
        })
        .catch((error) => {
          console.error('Erro na requisi√ß√£o:', error);
          mostrarModal(`‚ùå Erro ao enviar texto extra√≠do para an√°lise: ${error.message}.`);
          grecaptcha.reset(widgetIdExames);
        });
    }
    
    // Fun√ß√£o para mostrar popup de limite atingido
    function mostrarPopupLimite(mensagem) {
      // Criar overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;
      
      // Criar popup
      const popup = document.createElement('div');
      popup.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: popupSlideIn 0.3s ease-out;
      `;
      
      // Conte√∫do do popup
      popup.innerHTML = `
        <div style="margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">‚è∞</div>
          <h2 style="color: #d32f2f; margin: 0 0 15px 0; font-size: 24px;">Limite Di√°rio Atingido</h2>
          <p style="color: #666; line-height: 1.6; margin: 0 0 20px 0; font-size: 16px;">
            ${mensagem}
          </p>
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <p style="margin: 0; color: #856404; font-size: 14px;">
              <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> O acesso ser√° liberado automaticamente ap√≥s 24 horas.
            </p>
          </div>
        </div>
        <button onclick="irParaPlanos()" style="
          background: #0d2f66;
          color: white;
          border: none;
          padding: 12px 30px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 500;
          transition: all 0.3s ease;
        " onmouseover="this.style.background='#0a1f4d'" onmouseout="this.style.background='#0d2f66'">
          Ver Planos
        </button>
      `;
      
      // Adicionar CSS para anima√ß√£o
      const style = document.createElement('style');
      style.textContent = `
        @keyframes popupSlideIn {
          from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `;
      document.head.appendChild(style);
      
      // Adicionar ao DOM
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
      
      // Fechar ao clicar fora do popup
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          fecharPopupLimite();
        }
      });
      
      // Fechar com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          fecharPopupLimite();
        }
      });
    }
    
    // Fun√ß√£o para fechar popup
    function fecharPopupLimite() {
      const overlay = document.querySelector('div[style*="position: fixed"]');
      if (overlay) {
        overlay.remove();
      }
    }
    
    // Fun√ß√£o para ir para p√°gina de planos
    function irParaPlanos() {
      window.location.href = 'planos.php';
    }
    
    // Adiciona evento ao bot√£o de upload
    document.getElementById('btnUpload').onclick = analisarDocumento;
  </script>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <footer style="margin-top:40px; color:#888; font-size:0.95em; text-align:center;">
    <nav>
      <a href="paginas/termos.html" target="_blank">Termos de Uso</a> |
      <a href="paginas/privacidade.html" target="_blank">Pol√≠tica de Privacidade</a>
    </nav>
    <div style="margin-top:8px;">
      <strong>Contato:</strong> <a href="mailto:contato@readmylabs.com.br">contato@readmylabs.com.br</a>
    </div>
    <div style="margin-top:8px;">¬© 2025 Read My Labs. Todos os direitos reservados.</div>
  </footer>
 
  
</body>
</html>
